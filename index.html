<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload HTML File</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400&display=swap");

    /* Body Styles */
    body {
      font-family: 'Arial', sans-serif;
      background-color: #121212;
      color: #e0e0e0;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    /* Main Container */
    .container {
      background: #1e1e1e;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
      padding: 30px 40px;
      max-width: 400px;
      text-align: center;
    }

    /* Heading */
    h1 {
      font-size: 24px;
      margin-bottom: 15px;
      color: #e63946;
    }

    /* Description */
    .description {
      font-size: 14px;
      color: #bdbdbd;
      margin-bottom: 20px;
    }

    /* File Input */
    input[type="file"] {
      margin: 15px 0;
      font-size: 14px;
      color: #e0e0e0;
      background-color: #333;
      border: 1px solid #e63946;
      border-radius: 5px;
      padding: 5px;
    }

    /* Buttons */
    button {
      padding: 10px 20px;
      background-color: #e63946;
      border: none;
      border-radius: 5px;
      color: #121212;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #cc323e;
    }

    /* Loader Overlay */
    #loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    #spinnerContainer {
      position: relative;
      width: 80px;
      height: 80px;
    }

    .circle {
      animation: rotate 1s linear infinite;
      border: 8px solid rgba(255, 255, 255, 0.1);
      border-top: 8px solid #e63946;
      border-radius: 50%;
      width: 100%;
      height: 100%;
    }

    /* Checkmark for Success */
    #checkmark {
      stroke: #4caf50;
      /* Success green */
      stroke-width: 4px;
      visibility: hidden;
      stroke-dasharray: 100;
      stroke-dashoffset: 100;
      transition: stroke-dashoffset 0.5s ease-in-out, visibility 0.5s;
    }

    /* Adjust spinner and icons */
    .loading-circle {
      position: relative;
      width: 80px;
      height: 80px;
    }

    .loading-circle.complete .circle {
      display: none;
      /* Hide spinner on success */
    }

    .loading-circle.complete #checkmark {
      visibility: visible;
      stroke-dashoffset: 0;
    }

    #x-1,
    #x-2 {
      stroke: #e63946;
      /* Error red */
      stroke-width: 4px;
      visibility: hidden;
    }

    .loading-circle.error #x-1,
    .loading-circle.error #x-2 {
      visibility: visible;
    }

    /* Keyframes */
    @keyframes rotate {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Progress Text */
    #progressText {
      font-size: 16px;
      color: #e0e0e0;
      text-align: center;
      margin-top: 15px;
    }

    /* Close Button */
    #closeLoaderButton {
      margin-top: 10px;
      padding: 10px 20px;
      background-color: #e63946;
      border: none;
      border-radius: 5px;
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    #closeLoaderButton:hover {
      background-color: #cc323e;
    }

    /* Blur the container when the loader is active */
    body.loader-active .container {
      filter: blur(5px);
      pointer-events: none;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Activision Privacy Data Uploader</h1>
    <p class="description">Select the .html file that is included in your zip file.</p>
    <input type="file" id="fileInput" accept=".html">
    <button id="uploadButton">Upload</button>
    <p id="statusMessage"></p>
    <!-- SVG Spinner -->
    <div id="loader" style="display: none;">
      <div id="spinnerContainer" class="loading-circle">
        <div class="circle"></div>
        <svg viewBox="0 0 24 24">
          <path id="circle" fill="none"
            d="M 21.49999,11.999997 A 9.4999898,9.4999876 0 0 1 12,21.499984 9.4999898,9.4999876 0 0 1 2.50001,11.999997 9.4999898,9.4999876 0 0 1 12,2.50001 a 9.4999898,9.4999876 0 0 1 9.49999,9.499987 z" />
          <path id="checkmark" fill="none" d="m 7.7088497,11.82008 2.8615813,2.861579 5.720718,-5.720716" />
          <g>
            <path id="x-1" d="M 8.3100901,15.689906 15.68991,8.3100885" />
            <path id="x-2" d="M 15.689909,15.689907 8.3100913,8.3100873" />
          </g>
        </svg>
      </div>
      <p id="progressText"></p>
      <button id="closeLoaderButton" style="display: none;">âœ–</button>
    </div>
  </div>
</body>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const fileInput = document.getElementById('fileInput');
    const uploadButton = document.getElementById('uploadButton');
    const loader = document.getElementById('loader');
    const spinnerContainer = document.getElementById('spinnerContainer');
    const progressText = document.getElementById('progressText');
    const closeLoaderButton = document.getElementById('closeLoaderButton');

    // Function to log progress messages
    function logProgress(message) {
      console.log(message); // Log to the console
      progressText.textContent = message; // Update the progress text on screen
    }

    // Function to set loader state (loading, complete, or error)
    function setLoaderState(state) {
      const spinnerContainer = document.getElementById('spinnerContainer');
      spinnerContainer.className = `loading-circle ${state}`; // Adds the state: '', 'complete', 'error'
    }

    // Function to hide the loader
    function hideLoader() {
      loader.style.display = 'none';
      spinnerContainer.className = 'loading-circle'; // Reset to loading state
      progressText.textContent = ''; // Clear text
      closeLoaderButton.style.display = 'none'; // Hide close button
    }

    // Event listener for the close button
    closeLoaderButton.addEventListener('click', hideLoader);

    // Event listener for the upload button
    uploadButton.addEventListener('click', () => {
      const file = fileInput.files[0];

      // File validation
      if (!file) {
        logProgress('Error: Please select a file.');
        setLoaderState('error'); // Show error state
        closeLoaderButton.style.display = 'block';
        return;
      }

      if (!file.name.endsWith('.html')) {
        logProgress('Error: Only .html files are allowed.');
        setLoaderState('error'); // Show error state
        closeLoaderButton.style.display = 'block';
        return;
      }

      // Show loader and start processing
      loader.style.display = 'flex';
      logProgress('Reading file...');
      setLoaderState(''); // Reset to loading state
      closeLoaderButton.style.display = 'none';

      function filterTables(tables, keywords) {
        return Array.from(tables).filter((table) => {
          const heading = table.previousElementSibling?.textContent || ""; // Check the previous sibling for a heading
          return keywords.some((keyword) => heading.toLowerCase().includes(keyword.toLowerCase()));
        });
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        logProgress('Parsing HTML content...');
        const parser = new DOMParser();
        const doc = parser.parseFromString(e.target.result, 'text/html');

        const allTables = doc.querySelectorAll('table');
        logProgress(`Detected ${allTables.length} tables.`);

        // Filter tables based on headings
        const keywords = ["General", "Campaign Data"]; // Add desired table identifiers
        const filteredTables = filterTables(allTables, keywords);
        logProgress(`Filtered ${filteredTables.length} tables matching the keywords.`);

        if (filteredTables.length === 0) {
          logProgress('No relevant tables found.');
          setLoaderState('error'); // Show error state
          closeLoaderButton.style.display = 'block';
          return;
        }

        // Proceed to extract data from filtered tables
        processTables(filteredTables);
      };

      function processTables(tables) {
        let currentTable = 0;
        const extractedData = [];

        function processNextTable() {
          if (currentTable < tables.length) {
            logProgress(`Processing table ${currentTable + 1}...`);
            const table = tables[currentTable];
            const rows = table.querySelectorAll('tr');
            const tableData = [];

            rows.forEach((row) => {
              const rowData = [];
              row.querySelectorAll('td, th').forEach((cell) => {
                rowData.push(cell.textContent.trim());
              });
              tableData.push(rowData);
            });

            extractedData.push(tableData);
            logProgress(`Table ${currentTable + 1} processed.`);
            currentTable++;
            setTimeout(processNextTable, 1000); // Delay for better feedback
          } else {
            logProgress('All relevant tables processed.');
            console.log('Extracted Data:', extractedData);

            // Call createAndUploadSheet to upload data
            createAndUploadSheet(extractedData.flat());
          }
        }

        processNextTable();
      }

      function createAndUploadSheet(extractedData) {
        fetch('https://activision-privacy-data-visualizer.vercel.app/api/createSheet', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            data: extractedData,
            sheetName: 'Activision-Privacy-Data-Visualizer', // Optional: Name of the new sheet
          }),
        })
          .then((response) => response.json())
          .then((result) => {
            console.log('Spreadsheet created:', result);
            logProgress('Spreadsheet created and data uploaded successfully!');
          })
          .catch((error) => {
            console.error('Error creating spreadsheet:', error);
            logProgress('Error creating spreadsheet.');
          });
      }

      reader.onerror = function () {
        logProgress('Error reading the file.');
        setLoaderState('error'); // Show error state
        closeLoaderButton.style.display = 'block';
      };

      reader.readAsText(file);
    });
  });

</script>

</html>